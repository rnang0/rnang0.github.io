<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>微服务架构（10）：消息队列&amp;RabbitMQ | rnang0 Blog</title><meta name="description" content="学习目标 了解常见的MQ产品 了解RabbitMQ的5种消息模型 会使用Spring AMQP 利用MQ实现搜索和静态页的数据同步  1.RabbitMQ1.1.搜索与商品服务的问题目前我们已经完成了商品详情和搜索系统的开发。我们思考一下，是否存在问题？  商品的原始数据保存在数据库中，增删改查都在数据库中完成。 搜索服务数据来源是索引库，如果数据库商品发生变化，索引库数据不能及时更新。 商品详情"><meta name="keywords" content="乐优商城,消息队列,RabbitMQ"><meta name="author" content="rnang0"><meta name="copyright" content="rnang0"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="微服务架构（10）：消息队列&amp;RabbitMQ"><meta name="twitter:description" content="学习目标 了解常见的MQ产品 了解RabbitMQ的5种消息模型 会使用Spring AMQP 利用MQ实现搜索和静态页的数据同步  1.RabbitMQ1.1.搜索与商品服务的问题目前我们已经完成了商品详情和搜索系统的开发。我们思考一下，是否存在问题？  商品的原始数据保存在数据库中，增删改查都在数据库中完成。 搜索服务数据来源是索引库，如果数据库商品发生变化，索引库数据不能及时更新。 商品详情"><meta name="twitter:image" content="data:image/jpeg;base64,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uMvv+P8AuP8Aro3862dO8RQ2VhFbtBIzICCQRg85rCuJBNcySgEB2LYNbYqtCdGEYvVf5GWEozhWqSktH/mR13OgXX2rSo8nLR/I34f/AFq4atXRtXGltKHRnR8cKehrPA1lSq3lszTHUHWpWjujrp3j0/T3ZQFSJDgV56zF3Z2OWY5Nbmra+uoWf2eKJ0ywLFiOQKwqvH141JJQeiIwFCVKLc1qwr0OH/kGJ/1x/pXnldNH4ngS0WH7PJkJtzkelPAVoU3LndrizCjOqo8ivY5miiivPPROn8OasoQWU7YP/LNj/KtDV9Fj1ICRGEc4GA2OD7GuIrYsvEd5aqEkxOg6buo/GvSoYuDp+yrrQ8yvg5qp7ag7Mjfw7qaNgQBh6q4xV2x8LztIGvGWNB1RTkmrK+LYcfNayA+zCl/4S23/AOfaX8xVxp4JO/Nf+vQidTHNW5bf16m25WztcRQswQYWOMZJrj7nTdWvrp55LSTc5zzgYrV/4Sy3/wCfaX8xR/wllv8A8+sv5itq9TDVklKdku3/AAxhh6eJoNuMLt9/+HOcu7K4sXVLmPYzDcBkHj8Kr1pazqSancxypGyBE24b65rNryKqgptQd0ezSc3BOaswooorNFhRRRQAUUUUDCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAorX0jSLe/sr27urt7eK12ZKx7yd2ff2qndWsQZmsjPNAhAMrx7Rk/nWroTUFPo/v+4xVeDm4LdeWn37EMFvNdSeXBE0j4ztUZNJLbzQHE0MkZ9HUj+dWre11K1v08m3nW5jw4AQ5Hoa6p9b1nU9Vg0m5Uab5owSItzHjOef6VvRw8JxtO6ley00/SxhWxE4SvCzja711X53OIVWZtqqST2AzU8ljdwwefLbSxxZxvdCBn8a6qyNxp9tc3Gi6st39my09vNBtOM8kf/WrN1y81fXIY72ezkjtI1+Xap2e7VUsLCFO7bcvJafemyY4qc6lkko922n6WaW5z9Fa934cvrZI3jiedTEJXaNDhQe1ZyWlxKYgkEjGU4jwv3j7etcs6NSDtJHVCtTmuaMiGircOl39x5vk2k0nlHD7VJ2n0+tVpI3ikZJEZHU4KsMEVLhJK7RSnFuyY2iiipLCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigDc0bWV0rSdSjRiLmcx+V8oYcZznNTWWoWt1pF3bX135M0k6zbimQ2OowK52iumGLqRSjukmrev/DnLPCU5Ny2bad/S3+R1s/iC0lOrNFK8ZmgSKE4ILEfyqnc65A9/o1wpdzZxosrHqSDziueoq5Y6rL+vO5EMDSj/Xlb8jo01XTNPh1B7IzzXF4pQeYgVUUnJ+tXr7XbSayMtrPBG5thCY3Ri44+6O2K46imsfUScUlYTwFNtSbd/wCv8jtY9b0/7XbXn9oSBba2EZt9p+c47dqgttU0ySPSrie6ML2bsWi2Ek5PGK5Giq/tGp2X4+Xn5In+zqdtG/w8/LzZ2UF1DqdgsMM89sy3zTAojHzQTx078isjxc6v4nvCpBGVHHrtFZ9tqd9ZxNFbXUkSMclVPeqrMXYsxJYnJJ71NfFqrSULa6X+V/8AMdDCOlWc76a2+dn+nmJRRRXEd4UUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAH//Z"><meta property="og:type" content="article"><meta property="og:title" content="微服务架构（10）：消息队列&amp;RabbitMQ"><meta property="og:url" content="http://rnang0.github.io/2019/11/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%8810%EF%BC%89%EF%BC%9A%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97&amp;RabbitMQ/"><meta property="og:site_name" content="rnang0 Blog"><meta property="og:description" content="学习目标 了解常见的MQ产品 了解RabbitMQ的5种消息模型 会使用Spring AMQP 利用MQ实现搜索和静态页的数据同步  1.RabbitMQ1.1.搜索与商品服务的问题目前我们已经完成了商品详情和搜索系统的开发。我们思考一下，是否存在问题？  商品的原始数据保存在数据库中，增删改查都在数据库中完成。 搜索服务数据来源是索引库，如果数据库商品发生变化，索引库数据不能及时更新。 商品详情"><meta property="og:image" content="data:image/jpeg;base64,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uMvv+P8AuP8Aro3862dO8RQ2VhFbtBIzICCQRg85rCuJBNcySgEB2LYNbYqtCdGEYvVf5GWEozhWqSktH/mR13OgXX2rSo8nLR/I34f/AFq4atXRtXGltKHRnR8cKehrPA1lSq3lszTHUHWpWjujrp3j0/T3ZQFSJDgV56zF3Z2OWY5Nbmra+uoWf2eKJ0ywLFiOQKwqvH141JJQeiIwFCVKLc1qwr0OH/kGJ/1x/pXnldNH4ngS0WH7PJkJtzkelPAVoU3LndrizCjOqo8ivY5miiivPPROn8OasoQWU7YP/LNj/KtDV9Fj1ICRGEc4GA2OD7GuIrYsvEd5aqEkxOg6buo/GvSoYuDp+yrrQ8yvg5qp7ag7Mjfw7qaNgQBh6q4xV2x8LztIGvGWNB1RTkmrK+LYcfNayA+zCl/4S23/AOfaX8xVxp4JO/Nf+vQidTHNW5bf16m25WztcRQswQYWOMZJrj7nTdWvrp55LSTc5zzgYrV/4Sy3/wCfaX8xR/wllv8A8+sv5itq9TDVklKdku3/AAxhh6eJoNuMLt9/+HOcu7K4sXVLmPYzDcBkHj8Kr1pazqSancxypGyBE24b65rNryKqgptQd0ezSc3BOaswooorNFhRRRQAUUUUDCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAorX0jSLe/sr27urt7eK12ZKx7yd2ff2qndWsQZmsjPNAhAMrx7Rk/nWroTUFPo/v+4xVeDm4LdeWn37EMFvNdSeXBE0j4ztUZNJLbzQHE0MkZ9HUj+dWre11K1v08m3nW5jw4AQ5Hoa6p9b1nU9Vg0m5Uab5owSItzHjOef6VvRw8JxtO6ley00/SxhWxE4SvCzja711X53OIVWZtqqST2AzU8ljdwwefLbSxxZxvdCBn8a6qyNxp9tc3Gi6st39my09vNBtOM8kf/WrN1y81fXIY72ezkjtI1+Xap2e7VUsLCFO7bcvJafemyY4qc6lkko922n6WaW5z9Fa934cvrZI3jiedTEJXaNDhQe1ZyWlxKYgkEjGU4jwv3j7etcs6NSDtJHVCtTmuaMiGircOl39x5vk2k0nlHD7VJ2n0+tVpI3ikZJEZHU4KsMEVLhJK7RSnFuyY2iiipLCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigDc0bWV0rSdSjRiLmcx+V8oYcZznNTWWoWt1pF3bX135M0k6zbimQ2OowK52iumGLqRSjukmrev/DnLPCU5Ny2bad/S3+R1s/iC0lOrNFK8ZmgSKE4ILEfyqnc65A9/o1wpdzZxosrHqSDziueoq5Y6rL+vO5EMDSj/Xlb8jo01XTNPh1B7IzzXF4pQeYgVUUnJ+tXr7XbSayMtrPBG5thCY3Ri44+6O2K46imsfUScUlYTwFNtSbd/wCv8jtY9b0/7XbXn9oSBba2EZt9p+c47dqgttU0ySPSrie6ML2bsWi2Ek5PGK5Giq/tGp2X4+Xn5In+zqdtG/w8/LzZ2UF1DqdgsMM89sy3zTAojHzQTx078isjxc6v4nvCpBGVHHrtFZ9tqd9ZxNFbXUkSMclVPeqrMXYsxJYnJJ71NfFqrSULa6X+V/8AMdDCOlWc76a2+dn+nmJRRRXEd4UUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAH//Z"><meta property="article:published_time" content="2019-11-22T16:00:00.000Z"><meta property="article:modified_time" content="2020-05-21T12:11:39.108Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = 'false'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="canonical" href="http://rnang0.github.io/2019/11/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%8810%EF%BC%89%EF%BC%9A%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97&amp;RabbitMQ/"><link rel="prev" title="微服务架构（11）：Redis&amp;阿里云短信实现注册" href="http://rnang0.github.io/2019/11/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%8811%EF%BC%89%EF%BC%9ARedis&amp;%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C/"><link rel="next" title="微服务架构（9）：Thymeleaf页面静态化" href="http://rnang0.github.io/2019/11/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%889%EF%BC%89%EF%BC%9AThymeleaf%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'none',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/autor.JPG" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">75</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">105</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-mars"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#学习目标"><span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-RabbitMQ"><span class="toc-text">1.RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-搜索与商品服务的问题"><span class="toc-text">1.1.搜索与商品服务的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-消息队列（MQ）"><span class="toc-text">1.2.消息队列（MQ）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-什么是消息队列"><span class="toc-text">1.2.1.什么是消息队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-AMQP和JMS"><span class="toc-text">1.2.2.AMQP和JMS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-常见MQ产品"><span class="toc-text">1.2.3.常见MQ产品</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-4-RabbitMQ"><span class="toc-text">1.2.4.RabbitMQ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-下载和安装"><span class="toc-text">1.3.下载和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-下载"><span class="toc-text">1.3.1.下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-安装"><span class="toc-text">1.3.2.安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-五种消息模型"><span class="toc-text">2.五种消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-基本消息模型"><span class="toc-text">2.1.基本消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-生产者发送消息"><span class="toc-text">2.1.1.生产者发送消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-管理工具中查看消息"><span class="toc-text">2.1.2.管理工具中查看消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-消费者获取消息"><span class="toc-text">2.1.3.消费者获取消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4-消息确认机制（ACK）"><span class="toc-text">2.1.4.消息确认机制（ACK）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-1-自动ACK存在的问题"><span class="toc-text">2.1.4.1.自动ACK存在的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-2-演示手动ACK"><span class="toc-text">2.1.4.2.演示手动ACK</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-work消息模型"><span class="toc-text">2.2.work消息模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#面试题：避免消息堆积？"><span class="toc-text">面试题：避免消息堆积？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-生产者"><span class="toc-text">2.2.1.生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-消费者1"><span class="toc-text">2.2.2.消费者1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-消费者2"><span class="toc-text">2.2.3.消费者2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-能者多劳"><span class="toc-text">2.2.4.能者多劳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-订阅模型分类"><span class="toc-text">2.3.订阅模型分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-订阅模型-Fanout"><span class="toc-text">2.4.订阅模型-Fanout</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-生产者"><span class="toc-text">2.4.1.生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-消费者1"><span class="toc-text">2.4.2.消费者1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-消费者2"><span class="toc-text">2.4.3.消费者2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-4-测试"><span class="toc-text">2.4.4.测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-订阅模型-Direct"><span class="toc-text">2.5.订阅模型-Direct</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-生产者"><span class="toc-text">2.5.1.生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-消费者1"><span class="toc-text">2.5.2.消费者1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-3-消费者2"><span class="toc-text">2.5.3.消费者2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-4-测试"><span class="toc-text">2.5.4.测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-订阅模型-Topic"><span class="toc-text">2.6.订阅模型-Topic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-生产者"><span class="toc-text">2.6.1.生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-2-消费者1"><span class="toc-text">2.6.2.消费者1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-3-消费者2"><span class="toc-text">2.6.3.消费者2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-持久化"><span class="toc-text">2.7.持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-1-交换机持久化"><span class="toc-text">2.7.1.交换机持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-2-队列持久化"><span class="toc-text">2.7.2.队列持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-3-消息持久化"><span class="toc-text">2.7.3.消息持久化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Spring-AMQP"><span class="toc-text">3.Spring AMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-简介"><span class="toc-text">3.1.简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-依赖和配置"><span class="toc-text">2.2.依赖和配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-监听者"><span class="toc-text">2.3.监听者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-AmqpTemplate"><span class="toc-text">2.4.AmqpTemplate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-测试代码"><span class="toc-text">2.5.测试代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-项目改造"><span class="toc-text">3.项目改造</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-思路分析"><span class="toc-text">3.1.思路分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-商品服务发送消息"><span class="toc-text">3.2.商品服务发送消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-引入依赖"><span class="toc-text">3.2.1.引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-配置文件"><span class="toc-text">3.2.2.配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-改造GoodsService"><span class="toc-text">3.2.3.改造GoodsService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-搜索服务接收消息"><span class="toc-text">3.3.搜索服务接收消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-引入依赖"><span class="toc-text">3.3.1.引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-添加配置"><span class="toc-text">3.3.2.添加配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-编写监听器"><span class="toc-text">3.3.3.编写监听器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-编写创建和删除索引方法"><span class="toc-text">3.3.4.编写创建和删除索引方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-静态页服务接收消息"><span class="toc-text">3.4.静态页服务接收消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-引入依赖"><span class="toc-text">3.4.1.引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-添加配置"><span class="toc-text">3.4.2.添加配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-编写监听器"><span class="toc-text">3.4.3.编写监听器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-添加删除页面方法"><span class="toc-text">3.4.4.添加删除页面方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-测试"><span class="toc-text">3.5.测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-查看RabbitMQ控制台"><span class="toc-text">3.5.1.查看RabbitMQ控制台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-修改数据试一试"><span class="toc-text">3.5.2.修改数据试一试</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(data:image/jpeg;base64,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uMvv+P8AuP8Aro3862dO8RQ2VhFbtBIzICCQRg85rCuJBNcySgEB2LYNbYqtCdGEYvVf5GWEozhWqSktH/mR13OgXX2rSo8nLR/I34f/AFq4atXRtXGltKHRnR8cKehrPA1lSq3lszTHUHWpWjujrp3j0/T3ZQFSJDgV56zF3Z2OWY5Nbmra+uoWf2eKJ0ywLFiOQKwqvH141JJQeiIwFCVKLc1qwr0OH/kGJ/1x/pXnldNH4ngS0WH7PJkJtzkelPAVoU3LndrizCjOqo8ivY5miiivPPROn8OasoQWU7YP/LNj/KtDV9Fj1ICRGEc4GA2OD7GuIrYsvEd5aqEkxOg6buo/GvSoYuDp+yrrQ8yvg5qp7ag7Mjfw7qaNgQBh6q4xV2x8LztIGvGWNB1RTkmrK+LYcfNayA+zCl/4S23/AOfaX8xVxp4JO/Nf+vQidTHNW5bf16m25WztcRQswQYWOMZJrj7nTdWvrp55LSTc5zzgYrV/4Sy3/wCfaX8xR/wllv8A8+sv5itq9TDVklKdku3/AAxhh6eJoNuMLt9/+HOcu7K4sXVLmPYzDcBkHj8Kr1pazqSancxypGyBE24b65rNryKqgptQd0ezSc3BOaswooorNFhRRRQAUUUUDCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAorX0jSLe/sr27urt7eK12ZKx7yd2ff2qndWsQZmsjPNAhAMrx7Rk/nWroTUFPo/v+4xVeDm4LdeWn37EMFvNdSeXBE0j4ztUZNJLbzQHE0MkZ9HUj+dWre11K1v08m3nW5jw4AQ5Hoa6p9b1nU9Vg0m5Uab5owSItzHjOef6VvRw8JxtO6ley00/SxhWxE4SvCzja711X53OIVWZtqqST2AzU8ljdwwefLbSxxZxvdCBn8a6qyNxp9tc3Gi6st39my09vNBtOM8kf/WrN1y81fXIY72ezkjtI1+Xap2e7VUsLCFO7bcvJafemyY4qc6lkko922n6WaW5z9Fa934cvrZI3jiedTEJXaNDhQe1ZyWlxKYgkEjGU4jwv3j7etcs6NSDtJHVCtTmuaMiGircOl39x5vk2k0nlHD7VJ2n0+tVpI3ikZJEZHU4KsMEVLhJK7RSnFuyY2iiipLCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigDc0bWV0rSdSjRiLmcx+V8oYcZznNTWWoWt1pF3bX135M0k6zbimQ2OowK52iumGLqRSjukmrev/DnLPCU5Ny2bad/S3+R1s/iC0lOrNFK8ZmgSKE4ILEfyqnc65A9/o1wpdzZxosrHqSDziueoq5Y6rL+vO5EMDSj/Xlb8jo01XTNPh1B7IzzXF4pQeYgVUUnJ+tXr7XbSayMtrPBG5thCY3Ri44+6O2K46imsfUScUlYTwFNtSbd/wCv8jtY9b0/7XbXn9oSBba2EZt9p+c47dqgttU0ySPSrie6ML2bsWi2Ek5PGK5Giq/tGp2X4+Xn5In+zqdtG/w8/LzZ2UF1DqdgsMM89sy3zTAojHzQTx078isjxc6v4nvCpBGVHHrtFZ9tqd9ZxNFbXUkSMclVPeqrMXYsxJYnJJ71NfFqrSULa6X+V/8AMdDCOlWc76a2+dn+nmJRRRXEd4UUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAH//Z)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">rnang0 Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-mars"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">微服务架构（10）：消息队列&amp;RabbitMQ</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2019-11-23 00:00:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-11-23</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-05-21 20:11:39"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-05-21</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h1><ul>
<li>了解常见的MQ产品</li>
<li>了解RabbitMQ的5种消息模型</li>
<li>会使用Spring AMQP</li>
<li>利用MQ实现搜索和静态页的数据同步</li>
</ul>
<h1 id="1-RabbitMQ"><a href="#1-RabbitMQ" class="headerlink" title="1.RabbitMQ"></a>1.RabbitMQ</h1><h2 id="1-1-搜索与商品服务的问题"><a href="#1-1-搜索与商品服务的问题" class="headerlink" title="1.1.搜索与商品服务的问题"></a>1.1.搜索与商品服务的问题</h2><p>目前我们已经完成了商品详情和搜索系统的开发。我们思考一下，是否存在问题？</p>
<ul>
<li>商品的原始数据保存在数据库中，增删改查都在数据库中完成。</li>
<li><strong>搜索服务数据来源是索引库，如果数据库商品发生变化，索引库数据不能及时更新。</strong></li>
<li><strong>商品详情做了页面静态化，静态服务的页面数据也不会随着数据库商品发生变化。</strong></li>
</ul>
<p>如果我们在后台修改了商品的价格，搜索页面和商品详情页显示的依然是旧的价格，这样显然不对。该如何解决？</p>
<p>这里有两种解决方案：</p>
<ul>
<li>方案1：每当后台对商品做增删改操作，同时要修改索引库数据及静态页面</li>
<li>方案2：搜索服务和商品页面服务对外提供操作接口，后台在商品增删改后，调用接口</li>
</ul>
<p>以上两种方式都有同一个严重问题：<strong>就是代码耦合</strong>，后台服务中需要嵌入搜索和商品页面服务，违背了微服务的<code>独立</code>原则。</p>
<p>所以，我们会通过另外一种方式来解决这个问题：消息队列</p>
<h2 id="1-2-消息队列（MQ）"><a href="#1-2-消息队列（MQ）" class="headerlink" title="1.2.消息队列（MQ）"></a>1.2.消息队列（MQ）</h2><h3 id="1-2-1-什么是消息队列"><a href="#1-2-1-什么是消息队列" class="headerlink" title="1.2.1.什么是消息队列"></a>1.2.1.什么是消息队列</h3><p>消息队列，即MQ，Message Queue。</p>
<p><img src="https://img-blog.csdnimg.cn/20200221200603682.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><strong>消息队列是典型的：生产者、消费者模型</strong>。生产者不断向消息队列中生产消息，消费者不断的从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，这样就实现了生产者和消费者的解耦。</p>
<p>结合前面所说的问题：</p>
<ul>
<li>商品服务对商品增删改以后，无需去操作索引库或静态页面，<strong>只是发送一条消息</strong>，也不关心消息被谁接收。</li>
<li><strong>搜索服务和静态页面服务接收消息，分别去处理索引库和静态页面</strong>。</li>
</ul>
<p>如果以后有其它系统也依赖商品服务的数据，<strong>同样监听消息即可</strong>，商品服务无需任何代码修改。</p>
<h3 id="1-2-2-AMQP和JMS"><a href="#1-2-2-AMQP和JMS" class="headerlink" title="1.2.2.AMQP和JMS"></a>1.2.2.AMQP和JMS</h3><p>MQ是消息通信的模型，并不是具体实现。<strong>现在实现MQ的有两种主流方式：AMQP、JMS。</strong></p>
<p><img src="https://img-blog.csdnimg.cn/2020022120090420.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20200221200910583.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>两者间的区别和联系：</p>
<ul>
<li>JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过<strong>规定协议来统一数据交互的格式</strong></li>
<li>JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</li>
<li>JMS规定了两种消息模型；而<strong>AMQP的消息模型更加丰富</strong></li>
</ul>
<h3 id="1-2-3-常见MQ产品"><a href="#1-2-3-常见MQ产品" class="headerlink" title="1.2.3.常见MQ产品"></a>1.2.3.常见MQ产品</h3><p><img src="https://img-blog.csdnimg.cn/20200221201908832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>ActiveMQ：基于JMS</li>
<li><strong>RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好</strong></li>
<li><strong>RocketMQ：基于JMS，阿里巴巴产品，目前交由Apache基金会</strong></li>
<li><strong>Kafka：分布式消息系统，高吞吐量，高并发</strong></li>
</ul>
<h3 id="1-2-4-RabbitMQ"><a href="#1-2-4-RabbitMQ" class="headerlink" title="1.2.4.RabbitMQ"></a>1.2.4.RabbitMQ</h3><p>RabbitMQ是基于AMQP的一款<strong>消息管理系统</strong></p>
<p>官网： <a href="http://www.rabbitmq.com/" target="_blank" rel="noopener">http://www.rabbitmq.com/</a></p>
<p>官方教程：<a href="http://www.rabbitmq.com/getstarted.html" target="_blank" rel="noopener">http://www.rabbitmq.com/getstarted.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/20200221202014730.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20200221202023251.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>RabbitMQ基于Erlang语言开发：<br><img src="https://img-blog.csdnimg.cn/20200222165624230.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="1-3-下载和安装"><a href="#1-3-下载和安装" class="headerlink" title="1.3.下载和安装"></a>1.3.下载和安装</h2><h3 id="1-3-1-下载"><a href="#1-3-1-下载" class="headerlink" title="1.3.1.下载"></a>1.3.1.下载</h3><p>官网下载地址：<a href="http://www.rabbitmq.com/download.html" target="_blank" rel="noopener">http://www.rabbitmq.com/download.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/20200221202042769.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>目前最新版本是：3.7.5</p>
<p>我们使用的是：3.4.1版本</p>
<p><img src="https://img-blog.csdnimg.cn/20200221202053913.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="1-3-2-安装"><a href="#1-3-2-安装" class="headerlink" title="1.3.2.安装"></a>1.3.2.安装</h3><p><img src="https://img-blog.csdnimg.cn/20200221202123202.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h1 id="2-五种消息模型"><a href="#2-五种消息模型" class="headerlink" title="2.五种消息模型"></a>2.五种消息模型</h1><p>RabbitMQ提供了6种消息模型，但是第6种其实是RPC，并不是MQ，因此不予学习。那么也就剩下5种。</p>
<p>但是其实3、4、5这三种都属于订阅模型，只不过进行路由的方式不同。</p>
<p><img src="https://img-blog.csdnimg.cn/20200221202150166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们通过一个demo工程来了解下RabbitMQ的工作方式：</p>
<p>导入工程：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221202237602.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>导入后：<br><img src="https://img-blog.csdnimg.cn/20200221202242868.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>itcast-rabbitmq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们抽取一个建立RabbitMQ连接的工具类，方便其他程序获取连接：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 建立与RabbitMQ的连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//定义连接工厂</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        <span class="comment">//设置服务地址</span></span><br><span class="line">        factory.setHost(<span class="string">"192.168.56.101"</span>);</span><br><span class="line">        <span class="comment">//端口</span></span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        <span class="comment">//设置账号信息，用户名、密码、vhost</span></span><br><span class="line">        factory.setVirtualHost(<span class="string">"/leyou"</span>);</span><br><span class="line">        factory.setUsername(<span class="string">"leyou"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"leyou"</span>);</span><br><span class="line">        <span class="comment">// 通过工程获取连接</span></span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-1-基本消息模型"><a href="#2-1-基本消息模型" class="headerlink" title="2.1.基本消息模型"></a>2.1.基本消息模型</h2><p>官方介绍：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203125781.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>RabbitMQ是一个<strong>消息代理</strong>：它接受和转发消息。 你可以把它想象成一个邮局：当你把邮件放在邮箱里时，你可以确定邮差先生最终会把邮件发送给你的收件人。 <strong>在这个比喻中，RabbitMQ是邮政信箱，邮局和邮递员。</strong></p>
<p>RabbitMQ与邮局的主要区别是它不处理纸张，而是<strong>接受，存储和转发数据消息的二进制数据块。</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20200221203132387.png" alt="在这里插入图片描述"></p>
<p>P（producer/ publisher）：生产者，一个发送消息的用户应用程序。</p>
<p>C（consumer）：消费者，消费和接收有类似的意思，消费者是一个主要用来等待接收消息的用户应用程序</p>
<p>队列（红色区域）：rabbitmq内部类似于邮箱的一个概念。虽然消息流经rabbitmq和你的应用程序，但是它们只能存储在队列中。队列只受主机的内存和磁盘限制，<strong>实质上是一个大的消息缓冲区</strong>。许多生产者可以发送消息到一个队列，许多消费者可以尝试从一个队列接收数据。</p>
<p>总之：</p>
<p><strong>生产者将消息发送到队列，消费者从队列中获取消息，队列是存储消息的缓冲区。</strong></p>
<p>我们将用Java编写两个程序;发送单个消息的生产者，以及接收消息并将其打印出来的消费者。我们将详细介绍Java API中的一些细节，这是一个消息传递的“Hello World”。</p>
<p>我们将调用我们的消息发布者（发送者）Send和我们的消息消费者（接收者）Recv。发布者将连接到RabbitMQ，发送一条消息，然后退出。</p>
<h3 id="2-1-1-生产者发送消息"><a href="#2-1-1-生产者发送消息" class="headerlink" title="2.1.1.生产者发送消息"></a>2.1.1.生产者发送消息</h3><p><strong>必须声明队列才能够发送消息，我们可以把消息发送到队列中。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"simple_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接以及mq通道</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 从连接中创建通道，这是完成大部分API的地方。</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明（创建）队列，必须声明队列才能够发送消息，我们可以把消息发送到队列中。</span></span><br><span class="line">        <span class="comment">// 声明一个队列是幂等的 - 只有当它不存在时才会被创建</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息内容</span></span><br><span class="line">        String message = <span class="string">"Hello World!"</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭通道和连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203141745.png" alt="在这里插入图片描述"></p>
<h3 id="2-1-2-管理工具中查看消息"><a href="#2-1-2-管理工具中查看消息" class="headerlink" title="2.1.2.管理工具中查看消息"></a>2.1.2.管理工具中查看消息</h3><p>进入队列页面，可以看到新建了一个队列：simple_queue</p>
<p><img src="https://img-blog.csdnimg.cn/2020022120315768.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>点击队列名称，进入详情页，可以查看消息：<br><img src="https://img-blog.csdnimg.cn/20200221203214271.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>在控制台查看消息并不会将消息消费，所以消息还在。</p>
<h3 id="2-1-3-消费者获取消息"><a href="#2-1-3-消费者获取消息" class="headerlink" title="2.1.3.消费者获取消息"></a>2.1.3.消费者获取消息</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"simple_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 创建通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [x] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，第二个参数：是否自动进行消息确认。</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203223594.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>这个时候，队列中的消息就没了：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203232327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们发现，消费者已经获取了消息，但是程序没有停止，<strong>一直在监听队列中是否有新的消息。一旦有新的消息进入队列，就会立即打印.</strong></p>
<h3 id="2-1-4-消息确认机制（ACK）"><a href="#2-1-4-消息确认机制（ACK）" class="headerlink" title="2.1.4.消息确认机制（ACK）"></a>2.1.4.消息确认机制（ACK）</h3><p>通过刚才的案例可以看出，消息一旦被消费者接收，队列中的消息就会被删除。</p>
<p>那么问题来了：RabbitMQ怎么知道消息被接收了呢？</p>
<p>如果消费者领取消息后，还没执行操作就挂掉了呢？或者抛出了异常？消息消费失败，但是RabbitMQ无从得知，这样消息就丢失了！</p>
<p><strong>因此，RabbitMQ有一个ACK机制。当消费者获取消息后，会向RabbitMQ发送回执ACK，告知消息已经被接收</strong>。不过这种回执ACK分两种情况：</p>
<ul>
<li>自动ACK：消息一旦被接收，消费者自动发送ACK</li>
<li>手动ACK：消息接收后，不会发送ACK，需要手动调用</li>
</ul>
<p>大家觉得哪种更好呢？</p>
<p>这需要看消息的重要性：</p>
<ul>
<li>如果消息不太重要，丢失也没有影响，那么自动ACK会比较方便</li>
<li>如果消息非常重要，不容丢失。那么最好在消费完成后手动ACK，否则接收消息后就自动ACK，<strong>RabbitMQ就会把消息从队列中删除。如果此时消费者宕机，那么消息就丢失了。</strong></li>
</ul>
<p>我们之前的测试都是自动ACK的，如果要手动ACK，需要改动我们的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 手动进行ACK</span></span><br><span class="line">channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"simple_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 创建通道</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [x] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">                <span class="comment">// 手动进行ACK</span></span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，第二个参数false，手动进行ACK</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到最后一行代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br></pre></td></tr></table></figure>

<p>如果第二个参数为true，则会自动进行ACK；如果为false，则需要手动ACK。方法的声明：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203435239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h4 id="2-1-4-1-自动ACK存在的问题"><a href="#2-1-4-1-自动ACK存在的问题" class="headerlink" title="2.1.4.1.自动ACK存在的问题"></a>2.1.4.1.自动ACK存在的问题</h4><p>修改消费者，添加异常，如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203445762.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>生产者不做任何修改，直接运行，消息发送成功：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203453263.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>运行消费者，程序抛出异常。但是消息依然被消费：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203501122.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>管理界面：<br><img src="https://img-blog.csdnimg.cn/20200221203506979.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h4 id="2-1-4-2-演示手动ACK"><a href="#2-1-4-2-演示手动ACK" class="headerlink" title="2.1.4.2.演示手动ACK"></a>2.1.4.2.演示手动ACK</h4><p>修改消费者，把自动改成手动（去掉之前制造的异常）</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203515269.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>生产者不变，再次运行：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203521796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>运行消费者</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203527426.png" alt="在这里插入图片描述"><br>但是，查看管理界面，发现：</p>
<p><img src="https://img-blog.csdnimg.cn/202002212035332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>停掉消费者的程序，发现：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203539273.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>这是因为虽然我们设置了手动ACK，但是代码中并没有进行消息确认！所以消息并未被真正消费掉。</p>
<p><strong>当我们关掉这个消费者，消息的状态再次称为Ready</strong></p>
<p>修改代码手动ACK：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203546560.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>执行：</p>
<p><img src="https://img-blog.csdnimg.cn/20200221203616435.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>消息消费成功！</p>
<h2 id="2-2-work消息模型"><a href="#2-2-work消息模型" class="headerlink" title="2.2.work消息模型"></a>2.2.work消息模型</h2><p><strong>工作队列</strong>或者竞争消费者模式</p>
<p><img src="https://img-blog.csdnimg.cn/20200223094959324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>在第一篇教程中，我们编写了一个程序，从一个命名队列中发送并接受消息。在这里，我们将创建一个工作队列，在多个工作者之间分配耗时任务。</p>
<p>工作队列，又称任务队列。<strong>主要思想就是避免执行资源密集型任务时，必须等待它执行完成</strong>。相反我们稍后完成任务，我们将任务封装为消息并将其发送到队列。 在后台运行的工作进程将获取任务并最终执行作业。当你运行许多工人时，任务将在他们之间共享，但是一个消息只能被一个消费者获取。</p>
<p>这个概念在Web应用程序中特别有用，因为在短的HTTP请求窗口中无法处理复杂的任务。</p>
<p>接下来我们来模拟这个流程：</p>
<p>​    P：生产者：任务的发布者</p>
<p>​    C1：消费者，领取任务并且完成任务，假设完成速度较快</p>
<p>​    C2：消费者2：领取任务并完成任务，假设完成速度慢</p>
<h3 id="面试题：避免消息堆积？"><a href="#面试题：避免消息堆积？" class="headerlink" title="面试题：避免消息堆积？"></a>面试题：避免消息堆积？</h3><p>1） 采用workqueue，多个消费者监听同一队列。</p>
<p>2）接收到消息以后，而是通过线程池，异步消费。</p>
<h3 id="2-2-1-生产者"><a href="#2-2-1-生产者" class="headerlink" title="2.2.1.生产者"></a>2.2.1.生产者</h3><p>生产者与案例1中的几乎一样：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"test_work_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 循环发布任务</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// 消息内容</span></span><br><span class="line">            String message = <span class="string">"task .. "</span> + i;</span><br><span class="line">            channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(i * <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关闭通道和连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过这里我们是循环发送50条消息。</p>
<h3 id="2-2-2-消费者1"><a href="#2-2-2-消费者1" class="headerlink" title="2.2.2.消费者1"></a>2.2.2.消费者1</h3><p><img src="https://img-blog.csdnimg.cn/20200223095010634.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="2-2-3-消费者2"><a href="#2-2-3-消费者2" class="headerlink" title="2.2.3.消费者2"></a>2.2.3.消费者2</h3><p><img src="https://img-blog.csdnimg.cn/20200223095016682.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>与消费者1基本类似，就是没有设置消费耗时时间。</p>
<p>这里是模拟有些消费者快，有些比较慢。</p>
<p>接下来，两个消费者一同启动，然后发送50条消息：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223095022988.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>可以发现，两个消费者各自消费了25条消息，而且各不相同，这就实现了任务的分发。</p>
<h3 id="2-2-4-能者多劳"><a href="#2-2-4-能者多劳" class="headerlink" title="2.2.4.能者多劳"></a>2.2.4.能者多劳</h3><p>刚才的实现有问题吗？</p>
<ul>
<li>消费者1比消费者2的效率要低，一次任务的耗时较长</li>
<li>然而两人最终消费的消息数量是一样的</li>
<li>消费者2大量时间处于空闲状态，消费者1一直忙碌</li>
</ul>
<p>现在的状态属于是把任务平均分配，<strong>正确的做法应该是消费越快的人，消费的越多。</strong></p>
<p>怎么实现呢？</p>
<p>我们可以使用<strong>basicQos方法和prefetchCount = 1设置</strong>。 这告诉RabbitMQ一次不要向工作人员发送多于一条消息。 或者换句话说，不要向工作人员发送新消息，直到它处理并确认了前一个消息。 相反，它会将其分派给不是仍然忙碌的下一个工作人员。</p>
<p><img src="https://img-blog.csdnimg.cn/2020022309504158.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>再次测试：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223095053361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="2-3-订阅模型分类"><a href="#2-3-订阅模型分类" class="headerlink" title="2.3.订阅模型分类"></a>2.3.订阅模型分类</h2><p>在之前的模式中，我们创建了一个工作队列。 工作队列背后的假设是：每个任务只被传递给一个工作人员。 在这一部分，我们将做一些完全不同的事情 - 我们将会传递一个信息给多个消费者。 这种模式被称为“发布/订阅”。 </p>
<p>订阅模型示意图：</p>
<p>解读：</p>
<p>1、1个生产者，多个消费者</p>
<p>2、每一个消费者都有自己的一个队列</p>
<p>3、生产者没有将消息直接发送到队列，而是发送到了交换机</p>
<p>4、每个队列都要绑定到交换机</p>
<p>5、生产者发送的消息，经过交换机到达队列，实现一个消息被多个消费者获取的目的</p>
<p>X（Exchanges）：<strong>交换机一方面：接收生产者发送的消息。另一方面：知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。</strong></p>
<p>Exchange类型有以下几种：</p>
<p>​         Fanout：广播，将消息交给<strong>所有绑定到交换机的队列</strong></p>
<p>​         Direct：定向，把消息交给<strong>符合指定routing key 的队列</strong></p>
<p>​         Topic：通配符，把消息交给<strong>符合routing pattern（路由模式） 的队列</strong></p>
<p>我们这里先学习</p>
<p>​    Fanout：即广播模式</p>
<p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<h2 id="2-4-订阅模型-Fanout"><a href="#2-4-订阅模型-Fanout" class="headerlink" title="2.4.订阅模型-Fanout"></a>2.4.订阅模型-Fanout</h2><p>Fanout，也称为广播。</p>
<p>流程图：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223144920681.png" alt="在这里插入图片描述"></p>
<p>在广播模式下，消息发送流程是这样的：</p>
<ul>
<li>1）  可以有多个消费者</li>
<li>2）  每个<strong>消费者有自己的queue</strong>（队列）</li>
<li>3）  每个<strong>队列都要绑定到Exchange</strong>（交换机）</li>
<li>4）  <strong>生产者发送的消息，只能发送到交换机</strong>，交换机来决定要发给哪个队列，生产者无法决定。</li>
<li>5）  交换机把消息发送给绑定过的所有队列</li>
<li>6）  队列的消费者都能拿到消息。实现一条消息被多个消费者消费</li>
</ul>
<h3 id="2-4-1-生产者"><a href="#2-4-1-生产者" class="headerlink" title="2.4.1.生产者"></a>2.4.1.生产者</h3><p>两个变化：</p>
<ul>
<li>1）  声明Exchange，不再声明Queue</li>
<li>2）  发送消息到Exchange，不再发送到Queue</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"fanout_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 声明exchange，指定类型为fanout</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"fanout"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 消息内容</span></span><br><span class="line">        String message = <span class="string">"Hello everyone"</span>;</span><br><span class="line">        <span class="comment">// 发布消息到Exchange</span></span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, <span class="string">""</span>, <span class="keyword">null</span>, message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">" [生产者] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-2-消费者1"><a href="#2-4-2-消费者1" class="headerlink" title="2.4.2.消费者1"></a>2.4.2.消费者1</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"fanout_exchange_queue_1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"fanout_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定队列到交换机</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [消费者1] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，自动返回完成</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要注意代码中：<strong>队列需要和交换机绑定</strong></p>
<h3 id="2-4-3-消费者2"><a href="#2-4-3-消费者2" class="headerlink" title="2.4.3.消费者2"></a>2.4.3.消费者2</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"fanout_exchange_queue_2"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"fanout_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定队列到交换机</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [消费者2] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，手动返回完成</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-4-测试"><a href="#2-4-4-测试" class="headerlink" title="2.4.4.测试"></a>2.4.4.测试</h3><p>我们运行两个消费者，然后发送1条消息：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223153322407.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200223153328163.png" alt="在这里插入图片描述"></p>
<h2 id="2-5-订阅模型-Direct"><a href="#2-5-订阅模型-Direct" class="headerlink" title="2.5.订阅模型-Direct"></a>2.5.订阅模型-Direct</h2><p><strong>有选择性的接收消息</strong></p>
<p>在订阅模式中，生产者发布消息，所有消费者都可以获取所有消息。</p>
<p>在路由模式中，我们将添加一个功能 - 我们将只能订阅一部分消息。 例如，我们只能将重要的错误消息引导到日志文件（以节省磁盘空间），同时仍然能够在控制台上打印所有日志消息。</p>
<p>但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。</p>
<p>在Direct模型下，<strong>队列与交换机的绑定，不能是任意绑定了，而是要指定一个RoutingKey（路由key）</strong></p>
<p><strong>消息的发送方在向Exchange发送消息时，也必须指定消息的routing key。</strong></p>
<p><code>p会指定一个routing key，E也会指定一个routing key与消息队列进行绑定</code></p>
<p><img src="https://img-blog.csdnimg.cn/20200223153404415.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。</p>
<p>X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与routing key完全匹配的队列</p>
<p>C1：消费者，其所在队列指定了需要routing key 为 error 的消息</p>
<p>C2：消费者，其所在队列指定了需要routing key 为 info、error、warning 的消息</p>
<h3 id="2-5-1-生产者"><a href="#2-5-1-生产者" class="headerlink" title="2.5.1.生产者"></a>2.5.1.生产者</h3><p>此处我们模拟商品的增删改，发送消息的RoutingKey分别是：insert、update、delete</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"direct_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明exchange，指定类型为direct</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"direct"</span>);</span><br><span class="line">        <span class="comment">// 消息内容</span></span><br><span class="line">        String message = <span class="string">"商品新增了， id = 1001"</span>;</span><br><span class="line">        <span class="comment">// 发送消息，并且指定routing key 为：insert ,代表新增商品</span></span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, <span class="string">"insert"</span>, <span class="keyword">null</span>, message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">" [商品服务：] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-2-消费者1"><a href="#2-5-2-消费者1" class="headerlink" title="2.5.2.消费者1"></a>2.5.2.消费者1</h3><p>我们此处假设消费者1只接收两种类型的消息：更新商品和删除商品。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"direct_exchange_queue_1"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"direct_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绑定队列到交换机，同时指定需要订阅的routing key。假设此处需要update和delete消息</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"update"</span>);</span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"delete"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [消费者1] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，自动ACK</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5-3-消费者2"><a href="#2-5-3-消费者2" class="headerlink" title="2.5.3.消费者2"></a>2.5.3.消费者2</h3><p>我们此处假设消费者2接收所有类型的消息：新增商品，更新商品和删除商品。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"direct_exchange_queue_2"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"direct_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绑定队列到交换机，同时指定需要订阅的routing key。订阅 insert、update、delete</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"insert"</span>);</span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"update"</span>);</span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"delete"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [消费者2] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，自动ACK</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5-4-测试"><a href="#2-5-4-测试" class="headerlink" title="2.5.4.测试"></a>2.5.4.测试</h3><p>我们分别发送增、删、改的RoutingKey，发现结果：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223154020329.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="2-6-订阅模型-Topic"><a href="#2-6-订阅模型-Topic" class="headerlink" title="2.6.订阅模型-Topic"></a>2.6.订阅模型-Topic</h2><p><code>Topic</code>类型的<code>Exchange</code>与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候使用通配符！</p>
<p><code>Routingkey</code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p>
<p> 通配符规则：</p>
<p>​         <code>#</code>：匹配一个或多个词</p>
<p>​         <code>*</code>：匹配不多不少恰好1个词</p>
<p>举例：</p>
<p>​         <code>audit.#</code>：能够匹配<code>audit.irs.corporate</code> 或者 <code>audit.irs</code></p>
<p>​         <code>audit.*</code>：只能匹配<code>audit.irs</code><br><img src="https://img-blog.csdnimg.cn/20200223154236407.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>在这个例子中，我们将发送所有描述动物的消息。消息将使用由三个字（两个点）组成的routing key发送。路由关键字中的第一个单词将描述速度，第二个颜色和第三个种类：“<speed>.<color>.<species>”。</p>
<p>我们创建了三个绑定：Q1绑定了绑定键“* .orange.<em>”，Q2绑定了“</em>.*.rabbit”和“lazy.＃”。</p>
<p>Q1匹配所有的橙色动物。</p>
<p>Q2匹配关于兔子以及懒惰动物的消息。</p>
<p>练习，生产者发送如下消息，会进入那个队列：</p>
<p>quick.orange.rabbit à Q1 Q2</p>
<p>lazy.orange.elephant à Q1 Q2</p>
<p>quick.orange.fox à Q1</p>
<p>lazy.pink.rabbit à Q2</p>
<p>quick.brown.fox à 不匹配任意队列，被丢弃</p>
<p>quick.orange.male.rabbit à </p>
<p>orange à </p>
<h3 id="2-6-1-生产者"><a href="#2-6-1-生产者" class="headerlink" title="2.6.1.生产者"></a>2.6.1.生产者</h3><p>使用topic类型的Exchange，发送消息的routing key有3种： <code>item.isnert</code>、<code>item.update</code>、<code>item.delete</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"topic_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明exchange，指定类型为topic</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"topic"</span>);</span><br><span class="line">        <span class="comment">// 消息内容</span></span><br><span class="line">        String message = <span class="string">"新增商品 : id = 1001"</span>;</span><br><span class="line">        <span class="comment">// 发送消息，并且指定routing key 为：insert ,代表新增商品</span></span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, <span class="string">"item.insert"</span>, <span class="keyword">null</span>, message.getBytes());</span><br><span class="line">        System.out.println(<span class="string">" [商品服务：] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-2-消费者1"><a href="#2-6-2-消费者1" class="headerlink" title="2.6.2.消费者1"></a>2.6.2.消费者1</h3><p>我们此处假设消费者1只接收两种类型的消息：更新商品和删除商品</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"topic_exchange_queue_1"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"topic_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绑定队列到交换机，同时指定需要订阅的routing key。需要 update、delete</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"item.update"</span>);</span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"item.delete"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [消费者1] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，自动ACK</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-6-3-消费者2"><a href="#2-6-3-消费者2" class="headerlink" title="2.6.3.消费者2"></a>2.6.3.消费者2</h3><p>我们此处假设消费者2接收所有类型的消息：新增商品，更新商品和删除商品。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费者2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME = <span class="string">"topic_exchange_queue_2"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME = <span class="string">"topic_exchange_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到连接</span></span><br><span class="line">        Connection connection = ConnectionUtil.getConnection();</span><br><span class="line">        <span class="comment">// 获取通道</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 绑定队列到交换机，同时指定需要订阅的routing key。订阅 insert、update、delete</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"item.*"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义队列的消费者</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="comment">// 获取消息，并且处理，这个方法类似事件监听，如果有消息的时候，会被自动调用</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="comment">// body 即消息体</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(body);</span><br><span class="line">                System.out.println(<span class="string">" [消费者2] received : "</span> + msg + <span class="string">"!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 监听队列，自动ACK</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-7-持久化"><a href="#2-7-持久化" class="headerlink" title="2.7.持久化"></a>2.7.持久化</h2><p>如何避免消息丢失？</p>
<p>1）  消费者的<strong>ACK机制。可以防止消费者丢失消息。</strong></p>
<p>2）  但是，如果在消费者消费之前，MQ就宕机了，消息就没了。</p>
<p>是可以将消息进行持久化呢？</p>
<p> 要将消息持久化，前提是：队列、Exchange都持久化</p>
<h3 id="2-7-1-交换机持久化"><a href="#2-7-1-交换机持久化" class="headerlink" title="2.7.1.交换机持久化"></a>2.7.1.交换机持久化</h3><p><img src="https://img-blog.csdnimg.cn/20200223154821868.png" alt="在这里插入图片描述"></p>
<h3 id="2-7-2-队列持久化"><a href="#2-7-2-队列持久化" class="headerlink" title="2.7.2.队列持久化"></a>2.7.2.队列持久化</h3><p><img src="https://img-blog.csdnimg.cn/20200223154827547.png" alt="在这里插入图片描述"></p>
<h3 id="2-7-3-消息持久化"><a href="#2-7-3-消息持久化" class="headerlink" title="2.7.3.消息持久化"></a>2.7.3.消息持久化</h3><p><img src="https://img-blog.csdnimg.cn/20200223154832216.png" alt="在这里插入图片描述"></p>
<h1 id="3-Spring-AMQP"><a href="#3-Spring-AMQP" class="headerlink" title="3.Spring AMQP"></a>3.Spring AMQP</h1><h2 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1.简介"></a>3.1.简介</h2><p>Sprin有很多不同的项目，其中就有对AMQP的支持：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223154838510.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>Spring AMQP的页面：<a href="http://spring.io/projects/spring-amqp" target="_blank" rel="noopener">http://spring.io/projects/spring-amqp</a></p>
<p><img src="https://img-blog.csdnimg.cn/20200223154844482.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>注意这里一段描述：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223154851575.png" alt="在这里插入图片描述">                                      </p>
<p>​         Spring-amqp是对AMQP协议的抽象实现，而spring-rabbit 是对协议的具体实现，也是目前的唯一实现。<strong>底层使用的就是RabbitMQ。</strong></p>
<h2 id="2-2-依赖和配置"><a href="#2-2-依赖和配置" class="headerlink" title="2.2.依赖和配置"></a>2.2.依赖和配置</h2><p>添加AMQP的启动器：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>application.yml</code>中添加RabbitMQ地址：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/leyou</span></span><br></pre></td></tr></table></figure>

<h2 id="2-3-监听者"><a href="#2-3-监听者" class="headerlink" title="2.3.监听者"></a>2.3.监听者</h2><p>在SpringAmqp中，对消息的消费者进行了封装和抽象，一个普通的JavaBean中的普通方法，只要通过简单的注解，就可以成为一个消费者。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Listener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">            value = <span class="meta">@Queue</span>(value = <span class="string">"spring.test.queue"</span>, durable = <span class="string">"true"</span>),</span><br><span class="line">            exchange = <span class="meta">@Exchange</span>(</span><br><span class="line">                    value = <span class="string">"spring.test.exchange"</span>,</span><br><span class="line">                    ignoreDeclarationExceptions = <span class="string">"true"</span>,</span><br><span class="line">                    type = ExchangeTypes.TOPIC</span><br><span class="line">            ),</span><br><span class="line">            key = &#123;<span class="string">"#.#"</span>&#125;))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"接收到消息："</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@Componet</code>：类上的注解，注册到Spring容器</li>
<li><code>@RabbitListener</code>：方法上的注解，声明这个方法是一个消费者方法，需要指定下面的属性：<ul>
<li><code>bindings</code>：指定绑定关系，可以有多个。值是<code>@QueueBinding</code>的数组。<code>@QueueBinding</code>包含下面属性：<ul>
<li><code>value</code>：这个消费者关联的队列。值是<code>@Queue</code>，代表一个队列</li>
<li><code>exchange</code>：队列所绑定的交换机，值是<code>@Exchange</code>类型</li>
<li><code>key</code>：队列和交换机绑定的<code>RoutingKey</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>类似listen这样的方法在一个类中可以写多个，就代表多个消费者。</p>
<h2 id="2-4-AmqpTemplate"><a href="#2-4-AmqpTemplate" class="headerlink" title="2.4.AmqpTemplate"></a>2.4.AmqpTemplate</h2><p>Spring最擅长的事情就是封装，把他人的框架进行封装和整合。</p>
<p>Spring为AMQP提供了统一的消息处理模板：AmqpTemplate，非常方便的发送消息，其发送方法：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223154949535.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>红框圈起来的是比较常用的3个方法，分别是：</p>
<ul>
<li>指定交换机、RoutingKey和消息体</li>
<li>指定消息</li>
<li>指定RoutingKey和消息，会向默认的交换机发送消息</li>
</ul>
<h2 id="2-5-测试代码"><a href="#2-5-测试代码" class="headerlink" title="2.5.测试代码"></a>2.5.测试代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MqDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSend</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        String msg = <span class="string">"hello, Spring boot amqp"</span>;</span><br><span class="line">        <span class="keyword">this</span>.amqpTemplate.convertAndSend(<span class="string">"spring.test.exchange"</span>,<span class="string">"a.b"</span>, msg);</span><br><span class="line">        <span class="comment">// 等待10秒后再结束</span></span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-项目改造"><a href="#3-项目改造" class="headerlink" title="3.项目改造"></a>3.项目改造</h1><p>接下来，我们就改造项目，实现搜索服务、商品静态页的数据同步。</p>
<h2 id="3-1-思路分析"><a href="#3-1-思路分析" class="headerlink" title="3.1.思路分析"></a>3.1.思路分析</h2><blockquote>
<p>发送方：商品微服务</p>
</blockquote>
<ul>
<li><p>什么时候发？</p>
<p>当商品服务对商品进行写操作：增、删、改的时候，需要发送一条消息，通知其它服务。</p>
</li>
<li><p>发送什么内容？</p>
<p>对商品的增删改时其它服务可能需要新的商品数据，但是如果消息内容中包含全部商品信息，数据量太大，而且并不是每个服务都需要全部的信息。因此我们<strong>只发送商品id</strong>，其它服务可以根据id查询自己需要的信息。</p>
</li>
</ul>
<blockquote>
<p>接收方：搜索微服务、静态页微服务</p>
</blockquote>
<p>接收消息后如何处理？</p>
<ul>
<li>搜索微服务：<ul>
<li>增/改：添加新的数据到索引库</li>
<li>删：删除索引库数据</li>
</ul>
</li>
<li>静态页微服务：<ul>
<li>增：创建新的静态页</li>
<li>删：删除原来的静态页</li>
<li>改：创建新的静态页并删除原来的</li>
</ul>
</li>
</ul>
<h2 id="3-2-商品服务发送消息"><a href="#3-2-商品服务发送消息" class="headerlink" title="3.2.商品服务发送消息"></a>3.2.商品服务发送消息</h2><p>我们先在商品微服务<code>leyou-item-service</code>中实现发送消息。</p>
<h3 id="3-2-1-引入依赖"><a href="#3-2-1-引入依赖" class="headerlink" title="3.2.1.引入依赖"></a>3.2.1.引入依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-配置文件"><a href="#3-2-2-配置文件" class="headerlink" title="3.2.2.配置文件"></a>3.2.2.配置文件</h3><p>我们在application.yml中添加一些有关RabbitMQ的配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/leyou</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">exchange:</span> <span class="string">leyou.item.exchange</span></span><br><span class="line">    <span class="attr">publisher-confirms:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>template：有关<code>AmqpTemplate</code>的配置<ul>
<li>retry：失败重试<ul>
<li>enabled：开启失败重试</li>
<li>initial-interval：第一次重试的间隔时长</li>
<li>max-interval：最长重试间隔，超过这个间隔将不再重试</li>
<li>multiplier：下次重试间隔的倍数，此处是2即下次重试间隔是上次的2倍</li>
</ul>
</li>
<li>exchange：缺省的交换机名称，此处配置后，发送消息如果不指定交换机就会使用这个</li>
</ul>
</li>
<li>publisher-confirms：生产者确认机制，确保消息会正确发送，如果发送失败会有错误回执，从而触发重试</li>
</ul>
<h3 id="3-2-3-改造GoodsService"><a href="#3-2-3-改造GoodsService" class="headerlink" title="3.2.3.改造GoodsService"></a>3.2.3.改造GoodsService</h3><p>在GoodsService中封装一个发送消息到mq的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Long id, String type)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.amqpTemplate.convertAndSend(<span class="string">"item."</span> + type, id);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">"&#123;&#125;商品消息发送异常，商品id：&#123;&#125;"</span>, type, id, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里没有指定交换机，因此默认发送到了配置中的：<code>leyou.item.exchange</code></p>
<p><strong>注意：这里要把所有异常都try起来，不能让消息的发送影响到正常的业务逻辑</strong></p>
<p>然后在新增的时候调用：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223155054372.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>修改的时候调用：<br><img src="https://img-blog.csdnimg.cn/20200223155059302.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="3-3-搜索服务接收消息"><a href="#3-3-搜索服务接收消息" class="headerlink" title="3.3.搜索服务接收消息"></a>3.3.搜索服务接收消息</h2><p>搜索服务接收到消息后要做的事情：</p>
<ul>
<li>增：添加新的数据到索引库</li>
<li>删：删除索引库数据</li>
<li>改：修改索引库数据</li>
</ul>
<p>因为索引库的新增和修改方法是合二为一的，因此我们可以将这两类消息一同处理，删除另外处理。</p>
<h3 id="3-3-1-引入依赖"><a href="#3-3-1-引入依赖" class="headerlink" title="3.3.1.引入依赖"></a>3.3.1.引入依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-2-添加配置"><a href="#3-3-2-添加配置" class="headerlink" title="3.3.2.添加配置"></a>3.3.2.添加配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/leyou</span></span><br></pre></td></tr></table></figure>

<p>这里只是接收消息而不发送，所以不用配置template相关内容。</p>
<h3 id="3-3-3-编写监听器"><a href="#3-3-3-编写监听器" class="headerlink" title="3.3.3.编写监听器"></a>3.3.3.编写监听器</h3><p><img src="https://img-blog.csdnimg.cn/20200223155106421.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SearchService searchService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理insert和update的消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">            value = <span class="meta">@Queue</span>(value = <span class="string">"leyou.create.index.queue"</span>, durable = <span class="string">"true"</span>),</span><br><span class="line">            exchange = <span class="meta">@Exchange</span>(</span><br><span class="line">                    value = <span class="string">"leyou.item.exchange"</span>,</span><br><span class="line">                    ignoreDeclarationExceptions = <span class="string">"true"</span>,</span><br><span class="line">                    type = ExchangeTypes.TOPIC),</span><br><span class="line">            key = &#123;<span class="string">"item.insert"</span>, <span class="string">"item.update"</span>&#125;))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenCreate</span><span class="params">(Long id)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建或更新索引</span></span><br><span class="line">        <span class="keyword">this</span>.searchService.createIndex(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理delete的消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">            value = <span class="meta">@Queue</span>(value = <span class="string">"leyou.delete.index.queue"</span>, durable = <span class="string">"true"</span>),</span><br><span class="line">            exchange = <span class="meta">@Exchange</span>(</span><br><span class="line">                    value = <span class="string">"leyou.item.exchange"</span>,</span><br><span class="line">                    ignoreDeclarationExceptions = <span class="string">"true"</span>,</span><br><span class="line">                    type = ExchangeTypes.TOPIC),</span><br><span class="line">            key = <span class="string">"item.delete"</span>))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenDelete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 删除索引</span></span><br><span class="line">        <span class="keyword">this</span>.searchService.deleteIndex(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-4-编写创建和删除索引方法"><a href="#3-3-4-编写创建和删除索引方法" class="headerlink" title="3.3.4.编写创建和删除索引方法"></a>3.3.4.编写创建和删除索引方法</h3><p>这里因为要创建和删除索引，我们需要在SearchService中拓展两个方法，创建和删除索引：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndex</span><span class="params">(Long id)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Spu spu = <span class="keyword">this</span>.goodsClient.querySpuById(id);</span><br><span class="line">    <span class="comment">// 构建商品</span></span><br><span class="line">    Goods goods = <span class="keyword">this</span>.buildGoods(spu);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存数据到索引库</span></span><br><span class="line">    <span class="keyword">this</span>.goodsRepository.save(goods);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteIndex</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.goodsRepository.deleteById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建索引的方法可以从之前导入数据的测试类中拷贝和改造。</p>
<h2 id="3-4-静态页服务接收消息"><a href="#3-4-静态页服务接收消息" class="headerlink" title="3.4.静态页服务接收消息"></a>3.4.静态页服务接收消息</h2><p>商品静态页服务接收到消息后的处理：</p>
<ul>
<li>增：创建新的静态页</li>
<li>删：删除原来的静态页</li>
<li>改：创建新的静态页并删除原来的</li>
</ul>
<p>不过，我们编写的创建静态页的方法也具备覆盖以前页面的功能，因此：增和改的消息可以放在一个方法中处理，删除消息放在另一个方法处理。</p>
<h3 id="3-4-1-引入依赖"><a href="#3-4-1-引入依赖" class="headerlink" title="3.4.1.引入依赖"></a>3.4.1.引入依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-2-添加配置"><a href="#3-4-2-添加配置" class="headerlink" title="3.4.2.添加配置"></a>3.4.2.添加配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/leyou</span></span><br></pre></td></tr></table></figure>

<p>这里只是接收消息而不发送，所以不用配置template相关内容。</p>
<h3 id="3-4-3-编写监听器"><a href="#3-4-3-编写监听器" class="headerlink" title="3.4.3.编写监听器"></a>3.4.3.编写监听器</h3><p><img src="https://img-blog.csdnimg.cn/20200223155117111.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GoodsHtmlService goodsHtmlService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">            value = <span class="meta">@Queue</span>(value = <span class="string">"leyou.create.web.queue"</span>, durable = <span class="string">"true"</span>),</span><br><span class="line">            exchange = <span class="meta">@Exchange</span>(</span><br><span class="line">                    value = <span class="string">"leyou.item.exchange"</span>,</span><br><span class="line">                    ignoreDeclarationExceptions = <span class="string">"true"</span>,</span><br><span class="line">                    type = ExchangeTypes.TOPIC),</span><br><span class="line">            key = &#123;<span class="string">"item.insert"</span>, <span class="string">"item.update"</span>&#125;))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenCreate</span><span class="params">(Long id)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建页面</span></span><br><span class="line">        goodsHtmlService.createHtml(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener</span>(bindings = <span class="meta">@QueueBinding</span>(</span><br><span class="line">            value = <span class="meta">@Queue</span>(value = <span class="string">"leyou.delete.web.queue"</span>, durable = <span class="string">"true"</span>),</span><br><span class="line">            exchange = <span class="meta">@Exchange</span>(</span><br><span class="line">                    value = <span class="string">"leyou.item.exchange"</span>,</span><br><span class="line">                    ignoreDeclarationExceptions = <span class="string">"true"</span>,</span><br><span class="line">                    type = ExchangeTypes.TOPIC),</span><br><span class="line">            key = <span class="string">"item.delete"</span>))</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenDelete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建页面</span></span><br><span class="line">        goodsHtmlService.deleteHtml(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-4-添加删除页面方法"><a href="#3-4-4-添加删除页面方法" class="headerlink" title="3.4.4.添加删除页面方法"></a>3.4.4.添加删除页面方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteHtml</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"C:\\project\\nginx-1.14.0\\html\\item\\"</span>, id + <span class="string">".html"</span>);</span><br><span class="line">    file.deleteOnExit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-5-测试"><a href="#3-5-测试" class="headerlink" title="3.5.测试"></a>3.5.测试</h2><h3 id="3-5-1-查看RabbitMQ控制台"><a href="#3-5-1-查看RabbitMQ控制台" class="headerlink" title="3.5.1.查看RabbitMQ控制台"></a>3.5.1.查看RabbitMQ控制台</h3><p>重新启动项目，并且登录RabbitMQ管理界面：<a href="http://192.168.56.101:15672" target="_blank" rel="noopener">http://192.168.56.101:15672</a></p>
<p>可以看到，交换机已经创建出来了：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223155125580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>队列也已经创建完毕：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223155131377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>并且队列都已经绑定到交换机：</p>
<p><img src="https://img-blog.csdnimg.cn/20200223155136901.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="3-5-2-修改数据试一试"><a href="#3-5-2-修改数据试一试" class="headerlink" title="3.5.2.修改数据试一试"></a>3.5.2.修改数据试一试</h3><p>在后台修改商品数据的价格，分别在搜索及商品详情页查看是否统一。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">rnang0</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://rnang0.github.io/2019/11/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%8810%EF%BC%89%EF%BC%9A%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97&amp;RabbitMQ/">http://rnang0.github.io/2019/11/23/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%8810%EF%BC%89%EF%BC%9A%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97&amp;RabbitMQ/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://rnang0.github.io" target="_blank">rnang0 Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E/">乐优商城</a><a class="post-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><a class="post-meta__tags" href="/tags/RabbitMQ/">RabbitMQ</a></div><div class="post_share"><div class="social-share" data-image="https://img-blog.csdnimg.cn/20201228092946817.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/11/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%8811%EF%BC%89%EF%BC%9ARedis&amp;%E9%98%BF%E9%87%8C%E4%BA%91%E7%9F%AD%E4%BF%A1%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C/"><img class="prev_cover" src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3963401938,3599392423&amp;fm=26&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">微服务架构（11）：Redis&amp;阿里云短信实现注册</div></div></a></div><div class="next-post pull_right"><a href="/2019/11/21/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%EF%BC%889%EF%BC%89%EF%BC%9AThymeleaf%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96/"><img class="next_cover" src="https://img-blog.csdnimg.cn/20200914153132733.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70#pic_cente" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">微服务架构（9）：Thymeleaf页面静态化</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/27/微服务架构（11）：Redis&阿里云短信实现注册/" title="微服务架构（11）：Redis&阿里云短信实现注册"><img class="relatedPosts_cover" src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3963401938,3599392423&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-27</div><div class="relatedPosts_title">微服务架构（11）：Redis&阿里云短信实现注册</div></div></a></div><div class="relatedPosts_item"><a href="/2019/11/29/微服务架构（12）：JWT + RSA授权登录/" title="微服务架构（12）：JWT + RSA授权登录"><img class="relatedPosts_cover" src="https://img-blog.csdnimg.cn/20200225094751651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-29</div><div class="relatedPosts_title">微服务架构（12）：JWT + RSA授权登录</div></div></a></div><div class="relatedPosts_item"><a href="/2019/11/30/微服务架构（13）：LocalStorage本地存储&&Redis存储/" title="微服务架构（13）：LocalStorage本地存储&&Redis存储"><img class="relatedPosts_cover" src="https://img-blog.csdnimg.cn/20200226155643843.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-30</div><div class="relatedPosts_title">微服务架构（13）：LocalStorage本地存储&&Redis存储</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/11/微服务架构（14）：SpringCloud微服务项目技术总结/" title="微服务架构（14）：SpringCloud微服务项目技术总结"><img class="relatedPosts_cover" src="https://img-blog.csdnimg.cn/20200226223928509.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-12-11</div><div class="relatedPosts_title">微服务架构（14）：SpringCloud微服务项目技术总结</div></div></a></div><div class="relatedPosts_item"><a href="/2019/11/05/微服务架构（1）：SpringBoot/" title="微服务架构（1）：SpringBoot"><img class="relatedPosts_cover" src="https://img-blog.csdnimg.cn/20200526102406659.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-05</div><div class="relatedPosts_title">微服务架构（1）：SpringBoot</div></div></a></div><div class="relatedPosts_item"><a href="/2019/11/07/微服务架构（2）：微服务概述/" title="微服务架构（2）：微服务概述"><img class="relatedPosts_cover" src="https://img-blog.csdnimg.cn/20200127174454384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzNjA1MDg1,size_16,color_FFFFFF,t_70"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-07</div><div class="relatedPosts_title">微服务架构（2）：微服务概述</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By rnang0</div><div class="footer_custom_text">Hi, welcome to my <a href="http://rnang0.github.io/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script></body></html>